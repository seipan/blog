---
title: 'VirtualService -> HttpRoute'
description: 'VirtualService -> HttpRouteã‚’ç†è§£ã™ã‚‹'
pubDate: 2025-11-19
---

# å‰æ®µ
localã§è©¦ã—ãŸã„ã®ã§kindã‚’æ§‹ç¯‰ã™ã‚‹ã€‚versionã¯è¦‹ã¦ãªã„ã‘ã©å¤ã„ã‹ã‚‚ã€‚

```
go install sigs.k8s.io/kind@v0.22.0
```

clusterã‚’ä½œæˆã™ã‚‹ã€‚

```
> kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.29.2) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
> kubectl get nodes
NAME                 STATUS   ROLES           AGE   VERSION
kind-control-plane   Ready    control-plane   24s   v1.29.2
```

istioctlã‚’installã™ã‚‹ã€‚

```
curl -sL https://istio.io/downloadIstioctl | sh -
```

# Istio Tutorial

ã¾ãšã¯VirtualServiceã§Istioã‚’æ§‹ç¯‰ã—ã¦ã¿ã‚‹ã€‚ä»¥ä¸‹ã‚’å‚è€ƒã«ã™ã‚‹ã€‚

https://istio.io/latest/docs/setup/getting-started/

ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã“ã«å­˜åœ¨ã—ã¦ã„ã‚‹ã®ã‹ä¸æ˜ã™ããŸã®ã§istioã‚’cloneã—ã¦ããŸã€‚

```
git clone git@github.com:istio/istio.git
```

istioã‚’å…¥ã‚Œã‚‹

```
istioctl install -f samples/bookinfo/demo-profile-no-gateways.yaml -y
kubectl label namespace default istio-injection=enabled
```

gatewayCRDã‚’å…¥ã‚Œã‚‹ã€‚
```
kubectl get crd gateways.gateway.networking.k8s.io &> /dev/null || \
{ kubectl kustomize "github.com/kubernetes-sigs/gateway-api/config/crd?ref=v1.4.0" | kubectl apply -f -; }
```

## Sampleã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
ä¸€æ—¦ä½•ã‚‚è€ƒãˆãšã«applyã™ã‚‹ã€‚

```
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created
```

çµæœ

```
> kubectl get services
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
details       ClusterIP   10.96.73.168    <none>        9080/TCP   36s
kubernetes    ClusterIP   10.96.0.1       <none>        443/TCP    53m
productpage   ClusterIP   10.96.149.165   <none>        9080/TCP   35s
ratings       ClusterIP   10.96.174.181   <none>        9080/TCP   36s
reviews       ClusterIP   10.96.143.122   <none>        9080/TCP   36s
```

```
> kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"
<title>Simple Bookstore App</title>
```

GateWayã‚’applyã™ã‚‹ã€‚

```
kubectl apply -f samples/bookinfo/gateway-api/bookinfo-gateway.yaml
```

serviceType:ClusterIPã«anntateã™ã‚‹ã€‚

```
kubectl annotate gateway bookinfo-gateway networking.istio.io/service-type=ClusterIP --namespace=default
```

## VirtualServiceã‚’æ§‹æˆã™ã‚‹ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªã€end-user: jason ã¨ã„ã† HTTP ãƒ˜ãƒƒãƒ€ã‚’æŒã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ reviews v2 ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãã‚Œä»¥å¤–ã¯v3ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã‚ˆã†ãªVirtualServiceã‚’applyã™ã‚‹ã€‚

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v3
```

subsetã«åŸºã¥ãDesitinationRuleã‚‚å¿…è¦

```yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    loadBalancer:
      simple: RANDOM
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
```

ä»¥ä¸‹ã®ã‚ˆã†ã«VirtualServiceãŒä½œæˆã•ã‚Œã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚
```
> kubectl get virtualservice -A
NAMESPACE   NAME       GATEWAYS               HOSTS         AGE
default     bookinfo   ["bookinfo-gateway"]   ["*"]         5m23s
default     reviews                           ["reviews"]   6s
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼: jasonã§loginã™ã‚‹ã€‚ãã†ã™ã‚‹ã¨reviewã®é …ç›®ã®ã‚¤ãƒ«ã‚«ãŒ```Reviews served by: reviews-v2-75f48cdfc6-ppp6g ```ã¨ãªã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚

### ã©ã†ã§ã‚‚ã„ã„ã“ã¨

VirtualServiceã¯åŒã˜hostã«å¯¾ã—ã¦è¤‡æ•°ã®è¨­å®šã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ã¨å†…éƒ¨ã§conflictã—ã¦ã—ã¾ã†ã‚‰ã—ã„ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«åŒã˜host(reviews)ã«å¯¾ã—ã¦åˆ¥ã®VirtualServiceã‚’Applyã—ã¦ã¿ã‚‹ã€‚ä»¥ä¸‹ã¯ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’v1ã«æµã—ã¾ã™ã€‚

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: reviews-conflict
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 100
```

ã“ã„ã¤ã‚’applyã—ã¾ã—ãŸãŒã€æŒ™å‹•ã¯ä»¥å‰å‰ã®ã¾ã¾ã§ã™ã€‚istioctl analyzeã™ã‚‹ã¨ErrorãŒå‡ºã¦ã¾ã™ã€‚

```
Error [IST0109] (VirtualService default/reviews-conflict) The VirtualServices default/reviews,default/reviews-conflict associated with mesh gateway define the same host */reviews.default.svc.cluster.local which can lead to undefined behavior. This can be fixed by merging the conflicting VirtualServices into a single resource.
Error [IST0109] (VirtualService default/reviews) The VirtualServices default/reviews,default/reviews-conflict associated with mesh gateway define the same host */reviews.default.svc.cluster.local which can lead to undefined behavior. This can be fixed by merging the conflicting VirtualServices into a single resource.
```

## ã“ã‚Œã‚’HttpRouteã«ç½®ãæ›ãˆã‚‹
ã•ã£ãã¾ã§ã®VirtualServiceã‚’æ¶ˆã—å»ã‚Šã¾ã™ã€‚
```
kubectl delete virtualservice reviews reviews-conflict
```
æ¬¡ã«reviewsã®VirtualServiceã‚’HttpRouteã§å®Ÿç¾ã™ã‚‹ã€‚end-user: jason ã¨ã„ã† HTTP ãƒ˜ãƒƒãƒ€ã‚’æŒã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ reviews v2 ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãã‚Œä»¥å¤–ã¯v3ã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚
HttpRouteã¯istioã®subsetã‚’èªè­˜ã™ã‚‹ã™ã¹ãŒãªã•ãã†ã ã£ãŸã®ã§ã€Serviceã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

```
apiVersion: v1
kind: Service
metadata:
  name: reviews-v1
spec:
  selector:
    app: reviews
    version: v1
  ports:
  - port: 9080
    name: http
---
apiVersion: v1
kind: Service
metadata:
  name: reviews-v2
spec:
  selector:
    app: reviews
    version: v2
  ports:
  - port: 9080
    name: http
---
apiVersion: v1
kind: Service
metadata:
  name: reviews-v3
spec:
  selector:
    app: reviews
    version: v3
  ports:
  - port: 9080
    name: http
```

ã«å¯¾ã—ã¦ä»¥ä¸‹ã‚’applyã™ã‚‹ã€‚

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: reviews-jason-native
spec:
  parentRefs:
  - kind: Service
    group: ""
    name: reviews
  rules:
  - matches:
    - headers:
      - name: end-user
        value: jason
        type: Exact
    backendRefs:
    - name: reviews-v2
      port: 9080
  - backendRefs:
    - name: reviews-v3
      port: 9080
```

ã™ã‚‹ã¨jasonã®æ™‚ã ã‘review-2ã«ãªã‚‹ã€‚æ¬¡ã«ä»¥ä¸‹ã®è¨­å®šã‚’applyã™ã‚‹ã€‚

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: reviews-jason-native2
spec:
  parentRefs:
  - kind: Service
    group: ""
    name: reviews
  rules:
  - matches:
    - headers:
      - name: end-user
        value: jason2
        type: Exact
    backendRefs:
    - name: reviews-v1
      port: 9080
```

ã™ã‚‹ã¨ã€jason2ã®æ™‚ã ã‘review-1ã¨ãªã‚Šã€ãã‚Œä»¥å¤–ã ã¨review-3ã¨ãªã‚‹ã€‚

# æ„Ÿæƒ³
HTTPRouteã¯è¿½åŠ ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ å‡ºæ¥ã¦ã€ãã‚Œä»¥å¤–ãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æµã—æ–¹ãŒã§ãã¦ä¾¿åˆ©ã€‚
ã‚ãã¾ã§ã‚‚L7ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãªã®ã§ã€podå˜ä½ã§ã®ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã®åˆ¶å¾¡ã‚’ã—ã‚ˆã†ã¨æ€ã†ã¨VirtualServiceã¯å¿…è¦ãã†ã€‚